<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galaxy Digital — Hyperliquid</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:       #000000;
    --surface:  #080808;
    --surface2: #0d0d0d;
    --border:   #161616;
    --border-l: #1f1f1f;
    --text:     #e8e8e8;
    --text-dim: #888888;
    --muted:    #555555;
    --green:    #00d672;
    --green-bg: rgba(0,214,114,.06);
    --red:      #ff3b3b;
    --red-bg:   rgba(255,59,59,.06);
    --accent:   #ffffff;
    --mono:     'JetBrains Mono', 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    --sans:     'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    line-height: 1.4;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .app { max-width: 1440px; margin: 0 auto; }

  /* ── Top bar ──────────────────────────────────────────────────────── */
  .topbar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 24px;
    border-bottom: 1px solid var(--border);
  }
  .topbar-left { display: flex; align-items: center; gap: 12px; }
  .topbar-left h1 {
    font-size: .85rem; font-weight: 600; letter-spacing: .04em;
    text-transform: uppercase; color: var(--text);
  }
  .topbar-left .sep { color: var(--muted); font-size: .7rem; }
  .topbar-left .sub {
    font-family: var(--mono); font-size: .7rem; color: var(--text-dim);
    letter-spacing: .02em;
  }
  .topbar-right { display: flex; align-items: center; gap: 20px; }
  .live-pill {
    display: flex; align-items: center; gap: 6px;
    font-family: var(--mono); font-size: .68rem; font-weight: 500;
    color: var(--green); letter-spacing: .06em; text-transform: uppercase;
  }
  .live-pill .dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
    animation: glow 2s ease-in-out infinite;
  }
  @keyframes glow {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px var(--green); }
    50% { opacity: .4; box-shadow: 0 0 2px var(--green); }
  }
  .ts {
    font-family: var(--mono); font-size: .68rem;
    color: var(--muted); letter-spacing: .01em;
  }

  /* ── Metrics strip ────────────────────────────────────────────────── */
  .metrics {
    display: grid; grid-template-columns: repeat(6, 1fr);
    border-bottom: 1px solid var(--border);
  }
  @media (max-width: 960px) { .metrics { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 600px) { .metrics { grid-template-columns: repeat(2, 1fr); } }
  .metric {
    padding: 18px 24px;
    border-right: 1px solid var(--border);
  }
  .metric:last-child { border-right: none; }
  .metric-label {
    font-size: .65rem; text-transform: uppercase; letter-spacing: .1em;
    color: var(--muted); margin-bottom: 6px; font-weight: 500;
  }
  .metric-val {
    font-family: var(--mono); font-size: 1.35rem; font-weight: 700;
    letter-spacing: -0.03em; color: var(--text);
  }
  .metric-val.up   { color: var(--green); }
  .metric-val.down { color: var(--red); }
  .metric-sub {
    font-family: var(--mono); font-size: .68rem; color: var(--muted);
    margin-top: 3px;
  }
  .status-tag {
    display: inline-block;
    font-family: var(--mono); font-size: .72rem; font-weight: 600;
    letter-spacing: .06em; padding: 3px 8px; margin-top: 2px;
  }
  .status-tag.ok  { color: var(--green); background: var(--green-bg); }
  .status-tag.bad { color: var(--red);   background: var(--red-bg); }

  /* ── Content grid ─────────────────────────────────────────────────── */
  .content {
    display: grid; grid-template-columns: 1fr 1fr;
  }
  @media (max-width: 960px) { .content { grid-template-columns: 1fr; } }
  .col { border-right: 1px solid var(--border); }
  .col:last-child { border-right: none; }
  .section-head {
    padding: 12px 24px;
    border-bottom: 1px solid var(--border);
    font-size: .65rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: .1em; color: var(--muted);
  }

  /* ── Charts ───────────────────────────────────────────────────────── */
  .chart-area { padding: 16px 20px; border-bottom: 1px solid var(--border); }
  .chart-area canvas { width: 100% !important; }
  .chart-bar { height: 300px; }
  .chart-donut { height: 260px; }
  .chart-hbar { height: 220px; }

  /* ── Staking section ─────────────────────────────────────────────── */
  .staking-row {
    display: grid; grid-template-columns: 1fr 1fr;
    border-bottom: 1px solid var(--border);
  }
  @media (max-width: 960px) { .staking-row { grid-template-columns: 1fr; } }
  .staking-row .col { border-right: 1px solid var(--border); }
  .staking-row .col:last-child { border-right: none; }
  .stake-list { padding: 12px 24px; }
  .stake-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 0; border-bottom: 1px solid var(--border);
  }
  .stake-item:last-child { border-bottom: none; }
  .stake-item .label {
    font-family: var(--mono); font-size: .76rem; color: var(--text-dim);
  }
  .stake-item .validator {
    font-family: var(--mono); font-size: .62rem; color: var(--muted);
    margin-top: 1px;
  }
  .stake-item .amount {
    font-family: var(--mono); font-size: .82rem; font-weight: 600;
    color: var(--text); text-align: right;
  }
  .stake-item .amount .usd {
    font-size: .68rem; color: var(--muted); font-weight: 400;
  }
  .purple { color: #a78bfa !important; }
  .purple-bg { background: rgba(167,139,250,.06); }

  /* ── Table ─────────────────────────────────────────────────────────── */
  .table-section { border-top: 1px solid var(--border); }
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead th {
    position: sticky; top: 0;
    text-align: left; padding: 9px 16px;
    font-size: .62rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: .1em; color: var(--muted);
    background: var(--surface); border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  thead th:last-child { text-align: right; }
  tbody td {
    padding: 7px 16px;
    font-family: var(--mono); font-size: .76rem; font-weight: 400;
    color: var(--text-dim); border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  tbody td:last-child { text-align: right; }
  tbody tr:hover td { color: var(--text); background: var(--surface2); }
  .coin-name { color: var(--text); font-weight: 600; }
  .t-tag {
    font-family: var(--mono); font-size: .62rem; font-weight: 600;
    letter-spacing: .05em; padding: 1px 6px;
  }
  .t-tag.SPOT { color: var(--green); background: var(--green-bg); }
  .t-tag.PERP { color: var(--red);   background: var(--red-bg); }
  .val-up   { color: var(--green) !important; font-weight: 500; }
  .val-down { color: var(--red) !important; font-weight: 500; }

  /* ── Loading ───────────────────────────────────────────────────────── */
  #loading {
    position: fixed; inset: 0; background: #000;
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; z-index: 999; gap: 20px;
    transition: opacity .3s;
  }
  #loading.hidden { opacity: 0; pointer-events: none; }
  .ld-bar {
    width: 120px; height: 2px; background: var(--border); overflow: hidden;
    border-radius: 1px;
  }
  .ld-bar::after {
    content: ''; display: block; width: 40%; height: 100%;
    background: var(--text); animation: slide 1s ease-in-out infinite;
  }
  @keyframes slide { 0% { transform: translateX(-100%); } 100% { transform: translateX(350%); } }
  #loading p {
    font-family: var(--mono); font-size: .72rem;
    color: var(--muted); letter-spacing: .04em;
  }

  /* ── Footer ───────────────────────────────────────────────────────── */
  footer {
    padding: 14px 24px; border-top: 1px solid var(--border);
    font-family: var(--mono); font-size: .62rem;
    color: var(--muted); letter-spacing: .02em;
    display: flex; justify-content: space-between;
  }
  @media (max-width: 600px) { footer { flex-direction: column; gap: 4px; } }
</style>
</head>
<body>

<div id="loading">
  <div class="ld-bar"></div>
  <p>connecting to hyperliquid</p>
</div>

<div class="app">
  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-left">
      <h1>Galaxy Digital</h1>
      <span class="sep">/</span>
      <span class="sub">Hyperliquid Cluster</span>
    </div>
    <div class="topbar-right">
      <div class="live-pill"><span class="dot"></span> live</div>
      <span class="ts" id="last-updated">--:--:-- UTC</span>
    </div>
  </div>

  <!-- Metrics -->
  <div class="metrics">
    <div class="metric">
      <div class="metric-label">Spot Exposure</div>
      <div class="metric-val up" id="m-spot">—</div>
    </div>
    <div class="metric">
      <div class="metric-label">Perp Exposure</div>
      <div class="metric-val down" id="m-perp">—</div>
    </div>
    <div class="metric">
      <div class="metric-label">Net Delta</div>
      <div class="metric-val" id="m-delta">—</div>
    </div>
    <div class="metric">
      <div class="metric-label">Hedge Status</div>
      <div id="m-status">—</div>
    </div>
    <div class="metric">
      <div class="metric-label">24h Funding</div>
      <div class="metric-val" id="m-funding">—</div>
      <div class="metric-sub" id="m-count">— positions</div>
    </div>
    <div class="metric">
      <div class="metric-label">Staked HYPE</div>
      <div class="metric-val purple" id="m-staked">—</div>
      <div class="metric-sub" id="m-staked-usd">—</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="content">
    <div class="col">
      <div class="section-head">Exposure by Coin</div>
      <div class="chart-area"><div class="chart-bar"><canvas id="coinChart"></canvas></div></div>
    </div>
    <div class="col">
      <div class="section-head">Account Allocation</div>
      <div class="chart-area"><div class="chart-donut"><canvas id="accountChart"></canvas></div></div>
    </div>
  </div>

  <!-- Staking -->
  <div class="staking-row">
    <div class="col">
      <div class="section-head">Staking by Account</div>
      <div class="chart-area"><div class="chart-hbar"><canvas id="stakeChart"></canvas></div></div>
    </div>
    <div class="col">
      <div class="section-head">Delegation Details</div>
      <div class="stake-list" id="stake-list">
        <div style="padding:24px 0; text-align:center; font-family:var(--mono); font-size:.72rem; color:var(--muted)">Loading staking data…</div>
      </div>
    </div>
  </div>

  <!-- Positions table -->
  <div class="table-section">
    <div class="section-head">Open Positions</div>
    <div class="table-wrap" style="max-height:420px; overflow-y:auto">
      <table>
        <thead>
          <tr>
            <th>Account</th><th>Coin</th><th>Type</th>
            <th>Size</th><th>Mark Price</th><th>Notional</th>
          </tr>
        </thead>
        <tbody id="pos-tbody"></tbody>
      </table>
    </div>
  </div>

  <footer>
    <span>Data from Hyperliquid L1 &middot; 30s refresh</span>
    <span id="footer-count"></span>
  </footer>
</div>

<script>
const API = 'https://api.hyperliquid.xyz/info';
const CLUSTER = {
  'Master_Trading': '0xcaC19662Ec88d23Fa1c81aC0e8570B0cf2FF26b3',
  'Agent_1':        '0x69cc3ae720efdff1cd2a8edec79a7a3fac6e14fd',
  'Agent_2':        '0xc75a3fc98b0e1af7a95b6a720adf2e23806d2c7b',
  'Agent_3':        '0x62bc1fe6009388219dd84f9dca37930f6fb6fa22',
};

const $ = s => document.querySelector(s);
const fmt = n => {
  const a = Math.abs(n), s = n < 0 ? '-' : '';
  if (a >= 1e6) return s + '$' + (a / 1e6).toFixed(2) + 'M';
  if (a >= 1e3) return s + '$' + (a / 1e3).toFixed(1) + 'K';
  return s + '$' + a.toFixed(2);
};
const fmtN = n => n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const fmtD = n => '$' + fmtN(n);

async function hlPost(body) {
  const r = await fetch(API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  return r.json();
}

// ── Chart config ─────────────────────────────────────────────────────────────
Chart.defaults.color = '#555';
Chart.defaults.borderColor = '#161616';
Chart.defaults.font.family = "'JetBrains Mono', 'SF Mono', monospace";
Chart.defaults.font.size = 11;

const coinChart = new Chart($('#coinChart').getContext('2d'), {
  type: 'bar',
  data: { labels: [], datasets: [
    { label: 'SPOT', data: [], backgroundColor: 'rgba(0,214,114,.55)', hoverBackgroundColor: 'rgba(0,214,114,.8)', borderRadius: 1, borderSkipped: false },
    { label: 'PERP', data: [], backgroundColor: 'rgba(255,59,59,.55)', hoverBackgroundColor: 'rgba(255,59,59,.8)', borderRadius: 1, borderSkipped: false },
  ]},
  options: {
    responsive: true, maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { display: true, position: 'top', align: 'end',
        labels: { usePointStyle: true, pointStyle: 'rect', padding: 14, boxWidth: 8, boxHeight: 8,
          font: { size: 10, weight: '600' }, color: '#888' }
      },
      tooltip: {
        backgroundColor: '#111', borderColor: '#222', borderWidth: 1, titleColor: '#eee',
        bodyColor: '#aaa', bodyFont: { family: "'JetBrains Mono', monospace", size: 11 },
        padding: 10, cornerRadius: 2,
        callbacks: { label: ctx => ' ' + ctx.dataset.label + '  ' + fmtD(ctx.parsed.y) }
      }
    },
    scales: {
      y: { ticks: { callback: v => fmt(v), font: { size: 10 } }, grid: { color: '#111' } },
      x: { grid: { display: false }, ticks: { font: { size: 10, weight: '500' }, color: '#777' } }
    }
  }
});

const fmtHype = n => {
  const a = Math.abs(n), s = n < 0 ? '-' : '';
  if (a >= 1e6) return s + (a / 1e6).toFixed(2) + 'M';
  if (a >= 1e3) return s + (a / 1e3).toFixed(1) + 'K';
  return s + a.toFixed(2);
};

const ACCT_COLS = ['#e8e8e8', '#00d672', '#ff3b3b', '#666666', '#3b82f6', '#f59e0b'];
const accountChart = new Chart($('#accountChart').getContext('2d'), {
  type: 'doughnut',
  data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 0 }] },
  options: {
    responsive: true, maintainAspectRatio: false, cutout: '72%',
    plugins: {
      legend: { position: 'bottom',
        labels: { usePointStyle: true, pointStyle: 'circle', padding: 10, boxWidth: 7, boxHeight: 7,
          font: { size: 10, weight: '500' }, color: '#888' }
      },
      tooltip: {
        backgroundColor: '#111', borderColor: '#222', borderWidth: 1,
        bodyColor: '#aaa', bodyFont: { family: "'JetBrains Mono', monospace", size: 11 },
        padding: 10, cornerRadius: 2,
        callbacks: { label: ctx => ' ' + ctx.label + '  ' + fmtD(ctx.parsed) }
      }
    }
  }
});

// ── Staking chart ────────────────────────────────────────────────────────────
const stakeChart = new Chart($('#stakeChart').getContext('2d'), {
  type: 'bar',
  data: { labels: [], datasets: [
    { label: 'HYPE Staked', data: [], backgroundColor: 'rgba(167,139,250,.5)', hoverBackgroundColor: 'rgba(167,139,250,.8)', borderRadius: 1, borderSkipped: false }
  ]},
  options: {
    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#111', borderColor: '#222', borderWidth: 1,
        bodyColor: '#aaa', bodyFont: { family: "'JetBrains Mono', monospace", size: 11 },
        padding: 10, cornerRadius: 2,
        callbacks: { label: ctx => ' ' + fmtHype(ctx.parsed.x) + ' HYPE' }
      }
    },
    scales: {
      x: { ticks: { callback: v => fmtHype(v), font: { size: 10 } }, grid: { color: '#111' } },
      y: { grid: { display: false }, ticks: { font: { size: 10, weight: '500' }, color: '#888' } }
    }
  }
});

// ── Data fetch ───────────────────────────────────────────────────────────────
let firstLoad = true;

async function fetchData() {
  try {
    const entries = Object.entries(CLUSTER);
    const midsP = hlPost({ type: 'allMids' });
    const startTime = Date.now() - 86400000;
    const perpP = entries.map(([, a]) => hlPost({ type: 'clearinghouseState', user: a }));
    const spotP = entries.map(([, a]) => hlPost({ type: 'spotClearinghouseState', user: a }));
    const fundP = entries.map(([, a]) => hlPost({ type: 'userFunding', user: a, startTime }).catch(() => []));
    const stakeP = entries.map(([, a]) => hlPost({ type: 'delegations', user: a }).catch(() => []));
    const stakeSumP = entries.map(([, a]) => hlPost({ type: 'delegatorSummary', user: a }).catch(() => ({})));

    const [mids, ...rest] = await Promise.all([midsP, ...perpP, ...spotP, ...fundP, ...stakeP, ...stakeSumP]);
    const n = entries.length;
    const perpS = rest.slice(0, n);
    const spotS = rest.slice(n, n * 2);
    const fundD = rest.slice(n * 2, n * 3);
    const stakeD = rest.slice(n * 3, n * 4);
    const stakeSumD = rest.slice(n * 4, n * 5);

    const positions = [], byCoin = {}, byAcct = {};

    entries.forEach(([label], i) => {
      for (const pos of (perpS[i]?.assetPositions || [])) {
        const p = pos.position || {}, size = parseFloat(p.szi || 0);
        if (size === 0) continue;
        const coin = p.coin, price = parseFloat(mids[coin] || 0), usd = size * price;
        positions.push({ account: label, coin, size: +size.toFixed(4), type: 'PERP', price: +price.toFixed(2), usd_value: +usd.toFixed(2) });
        if (!byCoin[coin]) byCoin[coin] = { spot: 0, perp: 0 }; byCoin[coin].perp += usd;
        if (!byAcct[label]) byAcct[label] = { spot: 0, perp: 0 }; byAcct[label].perp += usd;
      }
      for (const s of (spotS[i]?.balances || [])) {
        const total = parseFloat(s.total || 0);
        if (total <= 0) continue;
        const coin = s.coin, pk = coin + '/USDC';
        const price = parseFloat(mids[pk] || mids[coin] || 0), usd = total * price;
        positions.push({ account: label, coin, size: +total.toFixed(4), type: 'SPOT', price: +price.toFixed(2), usd_value: +usd.toFixed(2) });
        if (!byCoin[coin]) byCoin[coin] = { spot: 0, perp: 0 }; byCoin[coin].spot += usd;
        if (!byAcct[label]) byAcct[label] = { spot: 0, perp: 0 }; byAcct[label].spot += usd;
      }
    });

    const spotV = positions.filter(p => p.type === 'SPOT').reduce((s, p) => s + p.usd_value, 0);
    const perpV = positions.filter(p => p.type === 'PERP').reduce((s, p) => s + p.usd_value, 0);
    const net = spotV + perpV;
    const hedged = spotV !== 0 ? Math.abs(net) < Math.abs(spotV) * 0.05 : Math.abs(net) < 1000;
    let totalFund = 0;
    fundD.forEach(ev => { if (Array.isArray(ev)) totalFund += ev.reduce((s, e) => s + parseFloat(e.delta?.usdc || e.usdc || 0), 0); });

    // Staking
    const hypePrice = parseFloat(mids['HYPE'] || 0);
    const stakeByAcct = {};
    const allDelegations = [];
    let totalStaked = 0;

    entries.forEach(([label], i) => {
      let acctStake = 0;
      const delegations = Array.isArray(stakeD[i]) ? stakeD[i] : [];
      for (const d of delegations) {
        const amt = parseFloat(d.amount || d.lockedUntilTimestamp ? 0 : 0) || parseFloat(d.amount || 0);
        if (amt > 0) {
          acctStake += amt;
          const validator = d.validator || d.validatorAddress || 'Unknown';
          const shortVal = validator.slice(0, 6) + '…' + validator.slice(-4);
          allDelegations.push({ account: label, validator: shortVal, validatorFull: validator, amount: amt });
        }
      }
      // Also check delegatorSummary for total
      const summary = stakeSumD[i] || {};
      const summaryTotal = parseFloat(summary.totalDelegated || summary.delegated || 0);
      if (summaryTotal > 0 && acctStake === 0) acctStake = summaryTotal;
      if (summaryTotal > acctStake) acctStake = summaryTotal;

      stakeByAcct[label] = acctStake;
      totalStaked += acctStake;
    });

    // Metrics
    $('#m-spot').textContent = fmt(spotV);
    $('#m-perp').textContent = fmt(perpV);
    const dEl = $('#m-delta');
    dEl.textContent = fmt(net);
    dEl.className = 'metric-val ' + (net >= 0 ? 'up' : 'down');
    $('#m-status').innerHTML = hedged
      ? '<span class="status-tag ok">DELTA NEUTRAL</span>'
      : '<span class="status-tag bad">DIRECTIONAL</span>';
    const fEl = $('#m-funding');
    fEl.textContent = fmtD(totalFund);
    fEl.className = 'metric-val ' + (totalFund >= 0 ? 'up' : 'down');
    $('#m-count').textContent = positions.length + ' positions';
    const now = new Date();
    $('#last-updated').textContent = now.toISOString().slice(11, 19) + ' UTC';
    $('#footer-count').textContent = positions.length + ' positions across ' + Object.keys(byAcct).length + ' accounts';

    // Charts
    const cl = Object.entries(byCoin).sort((a, b) => (Math.abs(b[1].spot) + Math.abs(b[1].perp)) - (Math.abs(a[1].spot) + Math.abs(a[1].perp)));
    coinChart.data.labels = cl.map(c => c[0]);
    coinChart.data.datasets[0].data = cl.map(c => +c[1].spot.toFixed(2));
    coinChart.data.datasets[1].data = cl.map(c => +c[1].perp.toFixed(2));
    coinChart.update('none');

    const al = Object.entries(byAcct);
    accountChart.data.labels = al.map(a => a[0]);
    accountChart.data.datasets[0].data = al.map(a => Math.abs(a[1].spot) + Math.abs(a[1].perp));
    accountChart.data.datasets[0].backgroundColor = al.map((_, i) => ACCT_COLS[i % ACCT_COLS.length]);
    accountChart.update('none');

    // Staking metric
    $('#m-staked').textContent = fmtHype(totalStaked) + ' HYPE';
    const stakeUsd = totalStaked * hypePrice;
    $('#m-staked-usd').textContent = stakeUsd > 0 ? '≈ ' + fmtD(stakeUsd) : '—';

    // Staking chart
    const stakeEntries = Object.entries(stakeByAcct).filter(([, v]) => v > 0);
    stakeChart.data.labels = stakeEntries.map(e => e[0]);
    stakeChart.data.datasets[0].data = stakeEntries.map(e => +e[1].toFixed(2));
    stakeChart.update('none');

    // Delegation detail list
    const stakeListEl = $('#stake-list');
    if (allDelegations.length > 0) {
      stakeListEl.innerHTML = allDelegations
        .sort((a, b) => b.amount - a.amount)
        .map(d => `<div class="stake-item">
          <div>
            <div class="label">${d.account}</div>
            <div class="validator">${d.validator}</div>
          </div>
          <div class="amount">
            ${fmtHype(d.amount)} HYPE
            <div class="usd">${fmtD(d.amount * hypePrice)}</div>
          </div>
        </div>`).join('');
    } else if (totalStaked > 0) {
      // Summary-only mode (no individual delegation breakdown)
      stakeListEl.innerHTML = Object.entries(stakeByAcct)
        .filter(([, v]) => v > 0)
        .sort((a, b) => b[1] - a[1])
        .map(([acct, amt]) => `<div class="stake-item">
          <div><div class="label">${acct}</div><div class="validator">via delegatorSummary</div></div>
          <div class="amount">${fmtHype(amt)} HYPE<div class="usd">${fmtD(amt * hypePrice)}</div></div>
        </div>`).join('');
    } else {
      stakeListEl.innerHTML = '<div style="padding:24px 0; text-align:center; font-family:var(--mono); font-size:.72rem; color:var(--muted)">No active staking delegations</div>';
    }

    // Table
    $('#pos-tbody').innerHTML = positions
      .sort((a, b) => Math.abs(b.usd_value) - Math.abs(a.usd_value))
      .map(p => `<tr>
        <td>${p.account}</td>
        <td class="coin-name">${p.coin}</td>
        <td><span class="t-tag ${p.type}">${p.type}</span></td>
        <td>${p.size.toLocaleString()}</td>
        <td>${fmtD(p.price)}</td>
        <td class="${p.usd_value >= 0 ? 'val-up' : 'val-down'}">${fmtD(p.usd_value)}</td>
      </tr>`).join('');

    if (firstLoad) { $('#loading').classList.add('hidden'); firstLoad = false; }
  } catch (err) { console.error('Fetch error:', err); }
}

fetchData();
setInterval(fetchData, 30000);
</script>
</body>
</html>
